clear,clc;close all;
%% 定义变量
syms x t P_0 P_1 P_2 P_3 Q_0 Q_1 Q_2 Q_3 beta_ip1 beta_i     real;%real确保在实数域
%% 定义矩阵:bernstein基函数矩阵,关联矩阵,控制点矩阵
B_matrix = arrayfun(@(i) B(i, 6), 0:6);

M = [  0 , 1    ,  0  , 0;
        - beta_i, 1   ,    beta_i, 0;
    - 2 * beta_i + 1/12, 5/6    , 2 * beta_i + 1/12, 0;
    0, 1/2, 1/2, 0;
    0,  2 * beta_ip1 + 1/12, 5/6   , - 2 * beta_ip1 + 1/12;
    0,    beta_ip1, 1    ,     - beta_ip1;
    0,   0 , 1     ,  0  ];
P_matrix = [P_0 P_1 P_2 P_3]';
r_x = (B_matrix*M*P_matrix);%曲线方程
BB = (B_matrix*M)';%BB为4行1列调配函数矩阵
%这里我考虑以后可能会用到V和P的控制点之间的关系,最后是V用P表示
V_matrix = M*P_matrix;
for i = 0:6
    % 使用 eval 函数创建变量名，并将对应的矩阵行赋值给变量
    eval(sprintf('v_%d = V_matrix(%d, :);', i, i+1));
end
B0 = BB(1);
B1 = BB(2);
B2 = BB(3);
B3 = BB(4);

%% 在四元数空间
%54-62行:根据KIM的方法将调配函数的累加和表示出来,BB_Allocation_fun_matrix是4*1矩阵
BB_flipped = flipud(BB);

% 计算累积和
BB_flipped_cumsum = cumsum(BB_flipped);

% 再次上下翻转以恢复原始顺序
BB_Allocation = flipud(BB_flipped_cumsum);
BB_Allocation_fun_matrix = simplify(BB_Allocation);
C_tilde_0 = BB_Allocation_fun_matrix(1);
C_tilde_1 = BB_Allocation_fun_matrix(2);
C_tilde_2 = BB_Allocation_fun_matrix(3);
C_tilde_3 = BB_Allocation_fun_matrix(4);







%% %绘制基函数累加和C图像


beta_array =  0.025*[1 1 1 1 1];

%% 绘制四元数旋转控制点在球上的轨迹图

 
Q0 = [ -0.022100000000000, 0.615700000000000, 0.559700000000000, 0.554100000000000];
Q1 = Q0;
Q2 = [ -0.022200000000000, 0.306500000000000, -0.245200000000000, 0.919500000000000];
Q3 = [ -0.022200000000000, -0.009200000000000, 0.402600000000000, 0.915100000000000];
Q4 = [ -0.099516867564659, -0.264250973283681, -0.214237782302162, 0.935077530915483];
Q5 = [ -0.022096619278684, -0.760408224603820, 0.230426734728430, 0.606790401451533];
Q6 = [ -0.022096619278684, -0.760408224603820, 0.230426734728430, 0.606790401451533];
 
 
% QQQ =     -0.022100000000000   0.615700000000000   0.559700000000000   0.554100000000000
%   -0.022174905373237   0.615386610556456   0.555399093675682   0.558753290696131
%   -0.022291187669387   0.614857607539048   0.548781421362874   0.565825040953995
%   -0.022459719849543   0.614016588734352   0.539460312408987   0.575610598476877
%   -0.022689969239512   0.612736806952101   0.527131366255390   0.588249176295029
%   -0.022987620554917   0.610860111589553   0.511563800601734   0.603729882715715
%   -0.023352712699745   0.608200563734417   0.492596988697567   0.621900901919904
%   -0.023778409247838   0.604552710886044   0.470141560325783   0.642482155603108
%   -0.024250510793319   0.599703973549362   0.444183812397852   0.665081647347962
%   -0.024747790511997   0.593450148248852   0.414791762509202   0.689215541150010
%   -0.025243186048492   0.585612677754977   0.382120999967734   0.714331795872496
%   -0.025705807777546   0.576056100336177   0.346418546226099   0.739836854679852
%   -0.026103628844839   0.564703993103219   0.308023214433131   0.765124499741508
%   -0.026406617815307   0.551551793889200   0.267361419240909   0.789605585526501
%   -0.026589979119976   0.536675130593519   0.224937975512654   0.812737032738817
%   -0.026637102094957   0.520232691523237   0.181322063758836   0.834048272377989
%   -0.026541806437402   0.502463192330872   0.137129147969028   0.853163331162912
%   -0.026309522725750   0.483676567838339   0.093000127912224   0.869816970946404
%   -0.025957161658294   0.464240059863541   0.049579328265766   0.883863724103018
%   -0.025511592095684   0.444560306262749   0.007493032415750   0.895279256561622
%   -0.025006842217306   0.425062800741993  -0.032669847122695   0.904154165149214
%   -0.024480330700908   0.406170157300007  -0.070373681256206   0.910680987895384
%   -0.023968596850190   0.388280484119248  -0.105147794245643   0.915135789586677
%   -0.023503106810292   0.371746890843788  -0.136593594538497   0.917856112388698
%   -0.023106752442900   0.356858787037374  -0.164387399647007   0.919217312142810
%   -0.022791622133541   0.343825254706040  -0.188279650849944   0.919609324258227
%   -0.022558503384814   0.332760463546643  -0.208091555971863   0.919415734126010
%   -0.022398366535265   0.323670891017891  -0.223710386142979   0.918996697826492
%   -0.022295759270283   0.316444024040999  -0.235084669424738   0.918676807679808
%   -0.022233582970585   0.310838231537304  -0.242220371157203   0.918738457559886
%     -0.022198084352868   0.306473551988926  -0.245178841591141   0.919420655966778
%   -0.022187818026064   0.304598613302687  -0.245125770773938   0.920057901443059
%   -0.022182016375287   0.302833646765643  -0.244074753060466   0.920919679154822
%   -0.022180736580581   0.301112146868569  -0.242044593751491   0.922019362361019
%   -0.022184430501372   0.299373248902531  -0.239054661023790   0.923364596423144
%   -0.022193915002962   0.297561538033387  -0.235124972919140   0.924957625153617
%   -0.022210292280321   0.295626858356128  -0.230276292183343   0.926795604647325
%   -0.022234841394756   0.293524127389498  -0.224530228460069   0.928870914054291
%   -0.022268897683060   0.291213160240873  -0.217909346544704   0.931171470883298
%   -0.022313732751467   0.288658506503332  -0.210437278746030   0.933681056714726
%   -0.022370444379758   0.285829301800179  -0.202138838884046   0.936379657652431
%   -0.022439862785521   0.282699134761010  -0.193040135066792   0.939243822453434
%   -0.022522477287488   0.279245929114704  -0.183168678133306   0.942247040027506
%   -0.022618385414321   0.275451839548020  -0.172553482518649   0.945360136879881
%   -0.022727264887699   0.271303159038627  -0.161225156283682   0.948551694061894
%   -0.022848367625469   0.266790234562991  -0.149215977149097   0.951788482280657
%   -0.022980533924420   0.261907387433247  -0.136559951570782   0.955035912987269
%   -0.023122224258964   0.256652834057093  -0.123292854181591   0.958258502505215
%   -0.023271565640503   0.251028602656970  -0.109452245291381   0.961420345572843
%   -0.023426409194864   0.245040441436541  -0.095077464570654   0.964485594057079
%   -0.023584395506351   0.238697713842039  -0.080209599530144   0.967418936055315
%   -0.023743024323225   0.232013276923063  -0.064891427935996   0.970186070147287
%   -0.023899725398770   0.225003339333234  -0.049167333854040   0.972754169200236
%   -0.024051927532932   0.217687296200333  -0.033083197583504   0.975092327881104
%   -0.024197123260960   0.210087538906514  -0.016686260306617   0.977171987901351
%   -0.024332927086026   0.202229238715902  -0.000024964832997   0.978967335024295
%   -0.024457125651244   0.194140104130196   0.016851225656436   0.980455662009798
%   -0.024567718771148   0.185850112802337   0.033892028473773   0.981617691961424
%   -0.024662950772007   0.177391219753568   0.051046559066399   0.982437856976735
%   -0.024741332103555   0.168797044482084   0.068263562228450   0.982904527577189
%   -0.024801651661872   0.160102540286947   0.085491653362416   0.983010189099722
%   -0.024842980686428   0.151343649729274   0.102679566037363   0.982751562051985
%   -0.024864669448091   0.142556950590062   0.119776401937472   0.982129664347134
%   -0.024866338216951   0.133779296943691   0.136731879228044   0.981149814317722
%   -0.024847864180282   0.125047460039329   0.153496575388418   0.979821574434559
%   -0.024809366067204   0.116397773568223   0.170022160673438   0.978158636696339
%   -0.024751188227045   0.107865787600380   0.186261618566384   0.976178651679973
%   -0.024673885806691   0.099485935014165   0.202169449873868   0.973903004221290
%   -0.024578212485910   0.091291213638597   0.217701857482584   0.971356539604291
%   -0.024465111969867   0.083312886608084   0.232816909242561   0.968567244951053
%   -0.024335714118945   0.075580202625309   0.247474676953512   0.965565891203803
%   -0.024191336234079   0.068120136975422   0.261637350000066   0.962385641660661
%   -0.024033489629294   0.060957153270904   0.275269322796700   0.959061633456574
%   -0.023863891231408   0.054112985068966   0.288337255851142   0.955630538665678
%   -0.023684479569846   0.047606435728324   0.300810110921913   0.952130111839709
%   -0.023497434177201   0.041453194193327   0.312659161416375   0.948598730792250
%   -0.023305197133754   0.035665663840152   0.323857979834469   0.945074937297004
%   -0.023110495276316   0.030252801116634   0.334382404693862   0.941596984098734
%   -0.022916361473548   0.025219960472695   0.344210489957985   0.938202394248413
%   -0.022726153366327   0.020568742023666   0.353322440512669   0.934927538280324
%   -0.022543568103749   0.016296838518443   0.361700537683382   0.931807234158980
%   -0.022372651894823   0.012397878494875   0.369329059137199   0.928874374247051
%   -0.022217803666482   0.008861262985046   0.376194197756027   0.926159582789730
%   -0.022083772795794   0.005671993765039   0.382283984185341   0.923690906581426
%   -0.021975651796075   0.002810491902671   0.387588217741885   0.921493540580222
%   -0.021898866013374   0.000252406212937   0.392098410191670   0.919589589264470
%   -0.021859163864012  -0.002031587848115   0.395807746574789   0.917997863481920
%   -0.021862612950042  -0.004075997367103   0.398711066746378   0.916733711420294
%   -0.021915609563314  -0.005920726793374   0.400804870615574   0.915808881122333
%   -0.022024911666142  -0.007611295010976   0.402087349190455   0.915231410669099
%   -0.022197708452286  -0.009199050349596   0.402558442472533   0.915005540751651
%   -0.022542053824326  -0.011255596386277   0.401962329790397   0.915330450050061
%   -0.023028047004647  -0.013362534947151   0.399900278391064   0.916192828532121
%   -0.023671199788551  -0.015637595192117   0.396418828994884   0.917652239105590
%   -0.024481363131416  -0.018180991719251   0.391533410091167   0.919679337150572
%   -0.025464819072769  -0.021076935357733   0.385263214460514   0.922235296098057
%   -0.026624575304203  -0.024394328100842   0.377631421443918   0.925272358975792
%   -0.027960705554523  -0.028187435976132   0.368665495705510   0.928734515173306
%   -0.029470687543013  -0.032496540981953   0.358397546792636   0.932558326247196
%   -0.031149709760171  -0.037348575706945   0.346864728763178   0.936673913063968
%   -0.032990933642979  -0.042757747602795   0.334109655609773   0.941006105902411
%   -0.034985709259909  -0.048726163500766   0.320180806148545   0.945475749298810
%   -0.037123750821267  -0.055244468224490   0.305132891405096   0.950001144440532
%   -0.039393283575217  -0.062292513502160   0.289027158236624   0.954499603861839
%   -0.041781176318817  -0.069840074400724   0.271931604859119   0.958889086178303
%   -0.044273074221082  -0.077847629938698   0.253921086958773   0.963089872758310
%   -0.046853545298555  -0.086267222306855   0.235077296991097   0.967026243743041
%   -0.049506251087860  -0.095043405334420   0.215488603925098   0.970628107868341
%   -0.052214148220703  -0.104114287735696   0.195249745873626   0.973832539275188
%   -0.054959723131468  -0.113412670639639   0.174461373552571   0.976585175040993
%   -0.057725257426671  -0.122867272417275   0.153229448110597   0.978841429576561
%   -0.060493116921955  -0.132404027405353   0.131664502342493   0.980567486282721
%   -0.063246053384201  -0.141947439314228   0.109880779418778   0.981741032817605
%   -0.065967504937478  -0.151421965403076   0.087995267814941   0.982351713760388
%   -0.068641879170387  -0.160753404329128   0.066126654903630   0.982401283046704
%   -0.071254802403934  -0.169870259241473   0.044394224504039   0.981903447896124
%   -0.073793319430445  -0.178705048367946   0.022916725419774   0.980883405605009
%   -0.076246030297498  -0.187195538056042   0.001811238537602   0.979377084074741
%   -0.078603154264361  -0.195285877838624  -0.018807930646150   0.977430105839441
%   -0.080856515684099  -0.202927623316149  -0.038830309149210   0.975096503253941
%   -0.082999451964227  -0.210080640063119  -0.058150241468174   0.972437219084863
%   -0.085026649573860  -0.216713889860660  -0.076667784724758   0.969518431794416
%   -0.086933919898443  -0.222806108747896  -0.094289501325984   0.966409748199701
%   -0.088717932178354  -0.228346394066080  -0.110929142061370   0.963182307908811
%   -0.090375925386151  -0.233334724252908  -0.126508218464561   0.959906844037138
%   -0.091905424286279  -0.237782440100091  -0.140956469175097   0.956651743302909
%   -0.093303986675207  -0.241712719081614  -0.154212230630693   0.953481145817049
%   -0.094569008514290  -0.245161074888894  -0.166222727394890   0.950453120824668
%   -0.095697610924990  -0.248175912323658  -0.176944301501327   0.947617949371885
%   -0.096686627370352  -0.250819163224303  -0.186342603141678   0.945016538321733
%   -0.097532700305817  -0.253167022340304  -0.194392766664079   0.942678982177435
%   -0.098232483594406  -0.255310793393506  -0.201079596071791   0.940623279526538
%   -0.098782929425267  -0.257357845479439  -0.206397782968504   0.938854199229055
%   -0.099181615659143  -0.259432669034369  -0.210352177185592   0.937362277300632
%   -0.099427040692813  -0.261678009337945  -0.212958126160628   0.936122908335308
%   -0.099518777275024  -0.264256044211203  -0.214241893485758   0.935095474881131
%     -0.099520462546567  -0.264260519177671  -0.214245521502261   0.935111309981164
%   -0.099512835958013  -0.265511722295780  -0.214399860898914   0.934722242406614
%   -0.099477163410945  -0.266871877471809  -0.214321471697399   0.934356597741914
%   -0.099413583572575  -0.268354625735223  -0.214013684078491   0.934009168731720
%   -0.099322283961370  -0.269972576747997  -0.213479770550350   0.933674744907730
%   -0.099203500566789  -0.271737328223406  -0.212722951810108   0.933348105316818
%   -0.099057515045265  -0.273659485004375  -0.211746403020349   0.933024011367415
%   -0.098884650020044  -0.275748677875090  -0.210553260504268   0.932697200130662
%   -0.098685262955866  -0.278013582173985  -0.209146628854737   0.932362378392018
%   -0.098459739026441  -0.280461936270995  -0.207529588444201   0.932014217710304
%   -0.098208483343091  -0.283100559967462  -0.205705203314405   0.931647350704621
%   -0.097931912866693  -0.285935372873461  -0.203676529417541   0.931256368754819
%   -0.097630448282135  -0.288971412814577  -0.201446623173587   0.930835821268249
%   -0.097304506074610  -0.292212854318449  -0.199018550302434   0.930380216634124
%   -0.096954491010266  -0.295663027230440  -0.196395394883917   0.929884024957017
%   -0.096580789189728  -0.299324435507702  -0.193580268594068   0.929341682632676
%   -0.096183761811799  -0.303198776241259  -0.190576320061844   0.928747598802398
%   -0.095763739755987  -0.307286958956646  -0.187386744287182   0.928096163696723
%   -0.095321019066357  -0.311589125244621  -0.184014792058586   0.927381758855046
%   -0.094855857395353  -0.316104668774589  -0.180463779306367   0.926598769185004
%   -0.094368471444610  -0.320832255744226  -0.176737096326348   0.925741596804103
%   -0.093859035420213  -0.325769845819331  -0.172838216808038   0.924804676586064
%   -0.093327680502244  -0.330914713617904  -0.168770706601142   0.923782493315717
%   -0.092774495312670  -0.336263470791715  -0.164538232154689   0.922669600339146
%   -0.092199527351584  -0.341812088757117  -0.160144568563982   0.921460639579954
%   -0.091602785359360  -0.347555922124337  -0.155593607162056   0.920150362778284
%   -0.090984242551370  -0.353489732870982  -0.150889362594277   0.918733653796381
%   -0.090343840662437  -0.359607715300928  -0.146035979317127   0.917205551823197
%   -0.089681494730093  -0.365903521824067  -0.141037737465092   0.915561275300812
%   -0.088997098538865  -0.372370289585581  -0.135899058032829   0.913796246387237
%   -0.088290530642227  -0.379000667965569  -0.130624507323471   0.911906115763606
%   -0.087561660874420  -0.385786846960954  -0.125218800617991   0.909886787588780
%   -0.086810357261027  -0.392720586451749  -0.119686805024898   0.907734444401081
%   -0.086036493234940  -0.399793246343098  -0.114033541474291   0.905445571765146
%   -0.085239955063155  -0.406995817563090  -0.108264185825311   0.903016982461884
%   -0.084420649389595  -0.414318953884383  -0.102384069061281   0.900445840021067
%   -0.083578510799870  -0.421753004525243  -0.096398676552401   0.897729681399335
%   -0.082713509315531  -0.429288047472962  -0.090313646371554   0.894866438611168
%   -0.081825657727859  -0.436913923459872  -0.084134766654717   0.891854459126746
%   -0.080915018684547  -0.444620270509568  -0.077867972003509   0.888692524858479
%   -0.079981711446734  -0.452396558958605  -0.071519338933544   0.885379869567280
%   -0.079025918238684  -0.460232126847148  -0.065095080378466   0.881916194530299
%   -0.078047890117894  -0.468116215560874  -0.058601539265749   0.878301682323787
%   -0.077047952299514  -0.476038005596179  -0.052045181186515   0.874537008587817
%   -0.076026508875672  -0.483986652311481  -0.045432586187709   0.870623351653744
%   -0.074984046877365  -0.491951321519383  -0.038770439720906   0.866562399930365
%   -0.073921139634201  -0.499921224767749  -0.032065522787787   0.862356356960533
%   -0.072838449395075  -0.507885654152535  -0.025324701327830   0.858007944076527
%   -0.071736729181017  -0.515834016501569  -0.018554914898946   0.853520400599401
%   -0.070616823849688  -0.523755866766511  -0.011763164706654   0.848897481544814
%   -0.069479670359332  -0.531640940459989  -0.004956501041844   0.844143452815337
%   -0.068326297228285  -0.539479184976476   0.001857989808881   0.839263083876599
%   -0.067157823194331  -0.547260789638806   0.008673199112797   0.834261637931926
%   -0.065975455086157  -0.554976214317394   0.015482009630166   0.829144859627025
%   -0.064780484926857  -0.562616216476129   0.022277309870178   0.823918960332674
%   -0.063574286296713  -0.570171876507520   0.029052008589306   0.818590601069108
%   -0.062358309989368  -0.577634621229953   0.035799049456685   0.813166873150768
%   -0.061134079001803  -0.584996245431674   0.042511425810780   0.807655276644053
%   -0.059903182904284  -0.592248931359324   0.049182195432033   0.802063696743694
%   -0.058667271641538  -0.599385266063332   0.055804495257276   0.796400378185123
%   -0.057428048820808  -0.606398256528050   0.062371555963581   0.790673897820750
%   -0.056187264546143  -0.613281342531073   0.068876716351793   0.784893135497248
%   -0.054946707861168  -0.620028407193520   0.075313437463306   0.779067243378739
%   -0.053708198864773  -0.626633785200960   0.081675316367651   0.773205613867142
%   -0.052473580565529  -0.633092268692984   0.087956099563171   0.767317846275868
%   -0.051244710541264  -0.639399110837943   0.094149695938339   0.761413712416521
%   -0.050023452470126  -0.645550027127908   0.100250189247237   0.755503121260276
%   -0.048811667598608  -0.651541194447237   0.106251850059176   0.749596082836292
%   -0.047611206210479  -0.657369247986122   0.112149147149352   0.743702671528761
%   -0.046423899158438  -0.663031276087896   0.117936758304869   0.737832988932266
%   -0.045251549517518  -0.668524813135578   0.123609580528134   0.731997126421930
%   -0.044095924416039  -0.673847830598954   0.129162739627667   0.726205127590583
%   -0.042958747096141  -0.678998726378269   0.134591599194556   0.720466950699940
%   -0.041841689251826  -0.683976312594207   0.139891768971095   0.714792431286680
%   -0.040746363687971  -0.688779801986174   0.145059112626491   0.709191245057432
%   -0.039674317339073  -0.693408793091841   0.150089754962774   0.703672871199260
%   -0.038627024681611  -0.697863254390341   0.154980088582177   0.698246556224253
%   -0.037605881568895  -0.702143507599430   0.159726780055101   0.692921278458545
%   -0.036612199512263  -0.706250210323202   0.164326775635328   0.687705713277565
%   -0.035647200427447  -0.710184338251574   0.168777306576227   0.682608199180711
%   -0.034712011860009  -0.713947167115718   0.173075894108318   0.677636704790021
%   -0.033807662698962  -0.717540254604806   0.177220354144538   0.672798796848945
%   -0.032935079383070  -0.720965422449009   0.181208801784912   0.668101609289059
%   -0.032095082599968  -0.724224738871455   0.185039655696882   0.663551813424584
%   -0.031288384474117  -0.727320501607993   0.188711642451365   0.659155589326985
%   -0.030515586235815  -0.730255221688039   0.192223800897501   0.654918598424686
%   -0.029777176360014  -0.733031608162582   0.195575486661010   0.650845957366190
%   -0.029073529160505  -0.735652553956595   0.198766376852126   0.646942213178558
%   -0.028404903822294  -0.738121123012732   0.201796475069025   0.643211319747240
%   -0.027771443852508  -0.740440538881205   0.204666116781654   0.639656615637779
%   -0.027173176928115  -0.742614174897388   0.207375975178717   0.636280803274609
%   -0.026610015117002  -0.744645546073741   0.209927067557418   0.633085929487267
%   -0.026081755447592  -0.746538302816427   0.212320762331255   0.630073367429393
%   -0.025588080801105  -0.748296226559323   0.214558786725833   0.627243799871097
%   -0.025128561099915  -0.749923227389157   0.216643235226253   0.624597203860201
%   -0.024702654765004  -0.751423343715293   0.218576578832162   0.622132836742538
%   -0.024309710415489  -0.752800744016169   0.220361675168148   0.619849223525614
%   -0.023948968783393  -0.754059730671749   0.222001779487701   0.617744145563319
%   -0.023619564817390  -0.755204745867495   0.223500556598699   0.615814630531884
%   -0.023320529950076  -0.756240379530413   0.224862093727154   0.614056943658474
%   -0.023050794504490  -0.757171379231681   0.226090914324038   0.612466580153748
%   -0.022809190217090  -0.758002661963260   0.227191992807314   0.611038258787856
%   -0.022594452856212  -0.758739327667748   0.228170770217959   0.609765916535654
%   -0.022405224917266  -0.759386674371615   0.229033170754895   0.608642704201065
%   -0.022240058378547  -0.759950214741826   0.229785619139289   0.607660982912303
%   -0.022097417504638  -0.760435693854780   0.230435058743872   0.606812321358865

  QQQ = [ ...

-0.022100000000000, 0.615700000000000, 0.559700000000000, 0.554100000000000; ...

-0.022174905373237, 0.615386610556456, 0.555399093675682, 0.558753290696131; ...

-0.022291187669387, 0.614857607539048, 0.548781421362874, 0.565825040953995; ...

-0.022459719849543, 0.614016588734352, 0.539460312408987, 0.575610598476877; ...

-0.022689969239512, 0.612736806952101, 0.527131366255390, 0.588249176295029; ...

-0.022987620554917, 0.610860111589553, 0.511563800601734, 0.603729882715715; ...

-0.023352712699745, 0.608200563734417, 0.492596988697567, 0.621900901919904; ...

-0.023778409247838, 0.604552710886044, 0.470141560325783, 0.642482155603108; ...

-0.024250510793319, 0.599703973549362, 0.444183812397852, 0.665081647347962; ...

-0.024747790511997, 0.593450148248852, 0.414791762509202, 0.689215541150010; ...

-0.025243186048492, 0.585612677754977, 0.382120999967734, 0.714331795872496; ...

-0.025705807777546, 0.576056100336177, 0.346418546226099, 0.739836854679852; ...

-0.026103628844839, 0.564703993103219, 0.308023214433131, 0.765124499741508; ...

-0.026406617815307, 0.551551793889200, 0.267361419240909, 0.789605585526501; ...

-0.026589979119976, 0.536675130593519, 0.224937975512654, 0.812737032738817; ...

-0.026637102094957, 0.520232691523237, 0.181322063758836, 0.834048272377989; ...

-0.026541806437402, 0.502463192330872, 0.137129147969028, 0.853163331162912; ...

-0.026309522725750, 0.483676567838339, 0.093000127912224, 0.869816970946404; ...

-0.025957161658294, 0.464240059863541, 0.049579328265766, 0.883863724103018; ...

-0.025511592095684, 0.444560306262749, 0.007493032415750, 0.895279256561622; ...

-0.025006842217306, 0.425062800741993, -0.032669847122695, 0.904154165149214; ...

-0.024480330700908, 0.406170157300007, -0.070373681256206, 0.910680987895384; ...

-0.023968596850190, 0.388280484119248, -0.105147794245643, 0.915135789586677; ...

-0.023503106810292, 0.371746890843788, -0.136593594538497, 0.917856112388698; ...

-0.023106752442900, 0.356858787037374, -0.164387399647007, 0.919217312142810; ...

-0.022791622133541, 0.343825254706040, -0.188279650849944, 0.919609324258227; ...

-0.022558503384814, 0.332760463546643, -0.208091555971863, 0.919415734126010; ...

-0.022398366535265, 0.323670891017891, -0.223710386142979, 0.918996697826492; ...

-0.022295759270283, 0.316444024040999, -0.235084669424738, 0.918676807679808; ...

-0.022233582970585, 0.310838231537304, -0.242220371157203, 0.918738457559886; ...

-0.022198084352868, 0.306473551988926, -0.245178841591141, 0.919420655966778; ...

-0.022187818026064, 0.304598613302687, -0.245125770773938, 0.920057901443059; ...

-0.022182016375287, 0.302833646765643, -0.244074753060466, 0.920919679154822; ...

-0.022180736580581, 0.301112146868569, -0.242044593751491, 0.922019362361019; ...

-0.022184430501372, 0.299373248902531, -0.239054661023790, 0.923364596423144; ...

-0.022193915002962, 0.297561538033387, -0.235124972919140, 0.924957625153617; ...

-0.022210292280321, 0.295626858356128, -0.230276292183343, 0.926795604647325; ...

-0.022234841394756, 0.293524127389498, -0.224530228460069, 0.928870914054291; ...

-0.022268897683060, 0.291213160240873, -0.217909346544704, 0.931171470883298; ...

-0.022313732751467, 0.288658506503332, -0.210437278746030, 0.933681056714726; ...

-0.022370444379758, 0.285829301800179, -0.202138838884046, 0.936379657652431; ...

-0.022439862785521, 0.282699134761010, -0.193040135066792, 0.939243822453434; ...

-0.022522477287488, 0.279245929114704, -0.183168678133306, 0.942247040027506; ...

-0.022618385414321, 0.275451839548020, -0.172553482518649, 0.945360136879881; ...

-0.022727264887699, 0.271303159038627, -0.161225156283682, 0.948551694061894; ...

-0.022848367625469, 0.266790234562991, -0.149215977149097, 0.951788482280657; ...

-0.022980533924420, 0.261907387433247, -0.136559951570782, 0.955035912987269; ...

-0.023122224258964, 0.256652834057093, -0.123292854181591, 0.958258502505215; ...

-0.023271565640503, 0.251028602656970, -0.109452245291381, 0.961420345572843; ...

-0.023426409194864, 0.245040441436541, -0.095077464570654, 0.964485594057079; ...

-0.023584395506351, 0.238697713842039, -0.080209599530144, 0.967418936055315; ...

-0.023743024323225, 0.232013276923063, -0.064891427935996, 0.970186070147287; ...

-0.023899725398770, 0.225003339333234, -0.049167333854040, 0.972754169200236; ...

-0.024051927532932, 0.217687296200333, -0.033083197583504, 0.975092327881104; ...

-0.024197123260960, 0.210087538906514, -0.016686260306617, 0.977171987901351; ...

-0.024332927086026, 0.202229238715902, -0.000024964832997, 0.978967335024295; ...

-0.024457125651244, 0.194140104130196, 0.016851225656436, 0.980455662009798; ...

-0.024567718771148, 0.185850112802337, 0.033892028473773, 0.981617691961424; ...

-0.024662950772007, 0.177391219753568, 0.051046559066399, 0.982437856976735; ...

-0.024741332103555, 0.168797044482084, 0.068263562228450, 0.982904527577189; ...

-0.024801651661872, 0.160102540286947, 0.085491653362416, 0.983010189099722; ...

-0.024842980686428, 0.151343649729274, 0.102679566037363, 0.982751562051985; ...

-0.024864669448091, 0.142556950590062, 0.119776401937472, 0.982129664347134; ...

-0.024866338216951, 0.133779296943691, 0.136731879228044, 0.981149814317722; ...

-0.024847864180282, 0.125047460039329, 0.153496575388418, 0.979821574434559; ...

-0.024809366067204, 0.116397773568223, 0.170022160673438, 0.978158636696339; ...

-0.024751188227045, 0.107865787600380, 0.186261618566384, 0.976178651679973; ...

-0.024673885806691, 0.099485935014165, 0.202169449873868, 0.973903004221290; ...

-0.024578212485910, 0.091291213638597, 0.217701857482584, 0.971356539604291; ...

-0.024465111969867, 0.083312886608084, 0.232816909242561, 0.968567244951053; ...

-0.024335714118945, 0.075580202625309, 0.247474676953512, 0.965565891203803; ...

-0.024191336234079, 0.068120136975422, 0.261637350000066, 0.962385641660661; ...

-0.024033489629294, 0.060957153270904, 0.275269322796700, 0.959061633456574; ...

-0.023863891231408, 0.054112985068966, 0.288337255851142, 0.955630538665678; ...

-0.023684479569846, 0.047606435728324, 0.300810110921913, 0.952130111839709; ...

-0.023497434177201, 0.041453194193327, 0.312659161416375, 0.948598730792250; ...

-0.023305197133754, 0.035665663840152, 0.323857979834469, 0.945074937297004; ...

-0.023110495276316, 0.030252801116634, 0.334382404693862, 0.941596984098734; ...

-0.022916361473548, 0.025219960472695, 0.344210489957985, 0.938202394248413; ...

-0.022726153366327, 0.020568742023666, 0.353322440512669, 0.934927538280324; ...

-0.022543568103749, 0.016296838518443, 0.361700537683382, 0.931807234158980; ...

-0.022372651894823, 0.012397878494875, 0.369329059137199, 0.928874374247051; ...

-0.022217803666482, 0.008861262985046, 0.376194197756027, 0.926159582789730; ...

-0.022083772795794, 0.005671993765039, 0.382283984185341, 0.923690906581426; ...

-0.021975651796075, 0.002810491902671, 0.387588217741885, 0.921493540580222; ...

-0.021898866013374, 0.000252406212937, 0.392098410191670, 0.919589589264470; ...

-0.021859163864012, -0.002031587848115, 0.395807746574789, 0.917997863481920; ...

-0.021862612950042, -0.004075997367103, 0.398711066746378, 0.916733711420294; ...

-0.021915609563314, -0.005920726793374, 0.400804870615574, 0.915808881122333; ...

-0.022024911666142, -0.007611295010976, 0.402087349190455, 0.915231410669099; ...

-0.022197708452286, -0.009199050349596, 0.402558442472533, 0.915005540751651; ...

-0.022542053824326, -0.011255596386277, 0.401962329790397, 0.915330450050061; ...

-0.023028047004647, -0.013362534947151, 0.399900278391064, 0.916192828532121; ...

-0.023671199788551, -0.015637595192117, 0.396418828994884, 0.917652239105590; ...

-0.024481363131416, -0.018180991719251, 0.391533410091167, 0.919679337150572; ...

-0.025464819072769, -0.021076935357733, 0.385263214460514, 0.922235296098057; ...

-0.026624575304203, -0.024394328100842, 0.377631421443918, 0.925272358975792; ...

-0.027960705554523, -0.028187435976132, 0.368665495705510, 0.928734515173306; ...

-0.029470687543013, -0.032496540981953, 0.358397546792636, 0.932558326247196; ...

-0.031149709760171, -0.037348575706945, 0.346864728763178, 0.936673913063968; ...

-0.032990933642979, -0.042757747602795, 0.334109655609773, 0.941006105902411; ...

-0.034985709259909, -0.048726163500766, 0.320180806148545, 0.945475749298810; ...

-0.037123750821267, -0.055244468224490, 0.305132891405096, 0.950001144440532; ...

-0.039393283575217, -0.062292513502160, 0.289027158236624, 0.954499603861839; ...

-0.041781176318817, -0.069840074400724, 0.271931604859119, 0.958889086178303; ...

-0.044273074221082, -0.077847629938698, 0.253921086958773, 0.963089872758310; ...

-0.046853545298555, -0.086267222306855, 0.235077296991097, 0.967026243743041; ...

-0.049506251087860, -0.095043405334420, 0.215488603925098, 0.970628107868341; ...

-0.052214148220703, -0.104114287735696, 0.195249745873626, 0.973832539275188; ...

-0.054959723131468, -0.113412670639639, 0.174461373552571, 0.976585175040993; ...

-0.057725257426671, -0.122867272417275, 0.153229448110597, 0.978841429576561; ...

-0.060493116921955, -0.132404027405353, 0.131664502342493, 0.980567486282721; ...

-0.063246053384201, -0.141947439314228, 0.109880779418778, 0.981741032817605; ...

-0.065967504937478, -0.151421965403076, 0.087995267814941, 0.982351713760388; ...

-0.068641879170387, -0.160753404329128, 0.066126654903630, 0.982401283046704; ...

-0.071254802403934, -0.169870259241473, 0.044394224504039, 0.981903447896124; ...

-0.073793319430445, -0.178705048367946, 0.022916725419774, 0.980883405605009; ...

-0.076246030297498, -0.187195538056042, 0.001811238537602, 0.979377084074741; ...

-0.078603154264361, -0.195285877838624, -0.018807930646150, 0.977430105839441; ...

-0.080856515684099, -0.202927623316149, -0.038830309149210, 0.975096503253941; ...

-0.082999451964227, -0.210080640063119, -0.058150241468174, 0.972437219084863; ...

-0.085026649573860, -0.216713889860660, -0.076667784724758, 0.969518431794416; ...

-0.086933919898443, -0.222806108747896, -0.094289501325984, 0.966409748199701; ...

-0.088717932178354, -0.228346394066080, -0.110929142061370, 0.963182307908811; ...

-0.090375925386151, -0.233334724252908, -0.126508218464561, 0.959906844037138; ...

-0.091905424286279, -0.237782440100091, -0.140956469175097, 0.956651743302909; ...

-0.093303986675207, -0.241712719081614, -0.154212230630693, 0.953481145817049; ...

-0.094569008514290, -0.245161074888894, -0.166222727394890, 0.950453120824668; ...

-0.095697610924990, -0.248175912323658, -0.176944301501327, 0.947617949371885; ...

-0.096686627370352, -0.250819163224303, -0.186342603141678, 0.945016538321733; ...

-0.097532700305817, -0.253167022340304, -0.194392766664079, 0.942678982177435; ...

-0.098232483594406, -0.255310793393506, -0.201079596071791, 0.940623279526538; ...

-0.098782929425267, -0.257357845479439, -0.206397782968504, 0.938854199229055; ...

-0.099181615659143, -0.259432669034369, -0.210352177185592, 0.937362277300632; ...

-0.099427040692813, -0.261678009337945, -0.212958126160628, 0.936122908335308; ...

-0.099518777275024, -0.264256044211203, -0.214241893485758, 0.935095474881131; ...

-0.099520462546567, -0.264260519177671, -0.214245521502261, 0.935111309981164; ...

-0.099512835958013, -0.265511722295780, -0.214399860898914, 0.934722242406614; ...

-0.099477163410945, -0.266871877471809, -0.214321471697399, 0.934356597741914; ...

-0.099413583572575, -0.268354625735223, -0.214013684078491, 0.934009168731720; ...

-0.099322283961370, -0.269972576747997, -0.213479770550350, 0.933674744907730; ...

-0.099203500566789, -0.271737328223406, -0.212722951810108, 0.933348105316818; ...

-0.099057515045265, -0.273659485004375, -0.211746403020349, 0.933024011367415; ...

-0.098884650020044, -0.275748677875090, -0.210553260504268, 0.932697200130662; ...

-0.098685262955866, -0.278013582173985, -0.209146628854737, 0.932362378392018; ...

-0.098459739026441, -0.280461936270995, -0.207529588444201, 0.932014217710304; ...

-0.098208483343091, -0.283100559967462, -0.205705203314405, 0.931647350704621; ...

-0.097931912866693, -0.285935372873461, -0.203676529417541, 0.931256368754819; ...

-0.097630448282135, -0.288971412814577, -0.201446623173587, 0.930835821268249; ...

-0.097304506074610, -0.292212854318449, -0.199018550302434, 0.930380216634124; ...

-0.096954491010266, -0.295663027230440, -0.196395394883917, 0.929884024957017; ...

-0.096580789189728, -0.299324435507702, -0.193580268594068, 0.929341682632676; ...

-0.096183761811799, -0.303198776241259, -0.190576320061844, 0.928747598802398; ...

-0.095763739755987, -0.307286958956646, -0.187386744287182, 0.928096163696723; ...

-0.095321019066357, -0.311589125244621, -0.184014792058586, 0.927381758855046; ...

-0.094855857395353, -0.316104668774589, -0.180463779306367, 0.926598769185004; ...

-0.094368471444610, -0.320832255744226, -0.176737096326348, 0.925741596804103; ...

-0.093859035420213, -0.325769845819331, -0.172838216808038, 0.924804676586064; ...

-0.093327680502244, -0.330914713617904, -0.168770706601142, 0.923782493315717; ...

-0.092774495312670, -0.336263470791715, -0.164538232154689, 0.922669600339146; ...

-0.092199527351584, -0.341812088757117, -0.160144568563982, 0.921460639579954; ...

-0.091602785359360, -0.347555922124337, -0.155593607162056, 0.920150362778284; ...

-0.090984242551370, -0.353489732870982, -0.150889362594277, 0.918733653796381; ...

-0.090343840662437, -0.359607715300928, -0.146035979317127, 0.917205551823197; ...

-0.089681494730093, -0.365903521824067, -0.141037737465092, 0.915561275300812; ...

-0.088997098538865, -0.372370289585581, -0.135899058032829, 0.913796246387237; ...

-0.088290530642227, -0.379000667965569, -0.130624507323471, 0.911906115763606; ...

-0.087561660874420, -0.385786846960954, -0.125218800617991, 0.909886787588780; ...

-0.086810357261027, -0.392720586451749, -0.119686805024898, 0.907734444401081; ...

-0.086036493234940, -0.399793246343098, -0.114033541474291, 0.905445571765146; ...

-0.085239955063155, -0.406995817563090, -0.108264185825311, 0.903016982461884; ...

-0.084420649389595, -0.414318953884383, -0.102384069061281, 0.900445840021067; ...

-0.083578510799870, -0.421753004525243, -0.096398676552401, 0.897729681399335; ...

-0.082713509315531, -0.429288047472962, -0.090313646371554, 0.894866438611168; ...

-0.081825657727859, -0.436913923459872, -0.084134766654717, 0.891854459126746; ...

-0.080915018684547, -0.444620270509568, -0.077867972003509, 0.888692524858479; ...

-0.079981711446734, -0.452396558958605, -0.071519338933544, 0.885379869567280; ...

-0.079025918238684, -0.460232126847148, -0.065095080378466, 0.881916194530299; ...

-0.078047890117894, -0.468116215560874, -0.058601539265749, 0.878301682323787; ...

-0.077047952299514, -0.476038005596179, -0.052045181186515, 0.874537008587817; ...

-0.076026508875672, -0.483986652311481, -0.045432586187709, 0.870623351653744; ...

-0.074984046877365, -0.491951321519383, -0.038770439720906, 0.866562399930365; ...

-0.073921139634201, -0.499921224767749, -0.032065522787787, 0.862356356960533; ...

-0.072838449395075, -0.507885654152535, -0.025324701327830, 0.858007944076527; ...

-0.071736729181017, -0.515834016501569, -0.018554914898946, 0.853520400599401; ...

-0.070616823849688, -0.523755866766511, -0.011763164706654, 0.848897481544814; ...

-0.069479670359332, -0.531640940459989, -0.004956501041844, 0.844143452815337; ...

-0.068326297228285, -0.539479184976476, 0.001857989808881, 0.839263083876599; ...

-0.067157823194331, -0.547260789638806, 0.008673199112797, 0.834261637931926; ...

-0.065975455086157, -0.554976214317394, 0.015482009630166, 0.829144859627025; ...

-0.064780484926857, -0.562616216476129, 0.022277309870178, 0.823918960332674; ...

-0.063574286296713, -0.570171876507520, 0.029052008589306, 0.818590601069108; ...

-0.062358309989368, -0.577634621229953, 0.035799049456685, 0.813166873150768; ...

-0.061134079001803, -0.584996245431674, 0.042511425810780, 0.807655276644053; ...

-0.059903182904284, -0.592248931359324, 0.049182195432033, 0.802063696743694; ...

-0.058667271641538, -0.599385266063332, 0.055804495257276, 0.796400378185123; ...

-0.057428048820808, -0.606398256528050, 0.062371555963581, 0.790673897820750; ...

-0.056187264546143, -0.613281342531073, 0.068876716351793, 0.784893135497248; ...

-0.054946707861168, -0.620028407193520, 0.075313437463306, 0.779067243378739; ...

-0.053708198864773, -0.626633785200960, 0.081675316367651, 0.773205613867142; ...

-0.052473580565529, -0.633092268692984, 0.087956099563171, 0.767317846275868; ...

-0.051244710541264, -0.639399110837943, 0.094149695938339, 0.761413712416521; ...

-0.050023452470126, -0.645550027127908, 0.100250189247237, 0.755503121260276; ...

-0.048811667598608, -0.651541194447237, 0.106251850059176, 0.749596082836292; ...

-0.047611206210479, -0.657369247986122, 0.112149147149352, 0.743702671528761; ...

-0.046423899158438, -0.663031276087896, 0.117936758304869, 0.737832988932266; ...

-0.045251549517518, -0.668524813135578, 0.123609580528134, 0.731997126421930; ...

-0.044095924416039, -0.673847830598954, 0.129162739627667, 0.726205127590583; ...

-0.042958747096141, -0.678998726378269, 0.134591599194556, 0.720466950699940; ...

-0.041841689251826, -0.683976312594207, 0.139891768971095, 0.714792431286680; ...

-0.040746363687971, -0.688779801986174, 0.145059112626491, 0.709191245057432; ...

-0.039674317339073, -0.693408793091841, 0.150089754962774, 0.703672871199260; ...

-0.038627024681611, -0.697863254390341, 0.154980088582177, 0.698246556224253; ...

-0.037605881568895, -0.702143507599430, 0.159726780055101, 0.692921278458545; ...

-0.036612199512263, -0.706250210323202, 0.164326775635328, 0.687705713277565; ...

-0.035647200427447, -0.710184338251574, 0.168777306576227, 0.682608199180711; ...

-0.034712011860009, -0.713947167115718, 0.173075894108318, 0.677636704790021; ...

-0.033807662698962, -0.717540254604806, 0.177220354144538, 0.672798796848945; ...

-0.032935079383070, -0.720965422449009, 0.181208801784912, 0.668101609289059; ...

-0.032095082599968, -0.724224738871455, 0.185039655696882, 0.663551813424584; ...

-0.031288384474117, -0.727320501607993, 0.188711642451365, 0.659155589326985; ...

-0.030515586235815, -0.730255221688039, 0.192223800897501, 0.654918598424686; ...

-0.029777176360014, -0.733031608162582, 0.195575486661010, 0.650845957366190; ...

-0.029073529160505, -0.735652553956595, 0.198766376852126, 0.646942213178558; ...

-0.028404903822294, -0.738121123012732, 0.201796475069025, 0.643211319747240; ...

-0.027771443852508, -0.740440538881205, 0.204666116781654, 0.639656615637779; ...

-0.027173176928115, -0.742614174897388, 0.207375975178717, 0.636280803274609; ...

-0.026610015117002, -0.744645546073741, 0.209927067557418, 0.633085929487267; ...

-0.026081755447592, -0.746538302816427, 0.212320762331255, 0.630073367429393; ...

-0.025588080801105, -0.748296226559323, 0.214558786725833, 0.627243799871097; ...

-0.025128561099915, -0.749923227389157, 0.216643235226253, 0.624597203860201; ...

-0.024702654765004, -0.751423343715293, 0.218576578832162, 0.622132836742538; ...

-0.024309710415489, -0.752800744016169, 0.220361675168148, 0.619849223525614; ...

-0.023948968783393, -0.754059730671749, 0.222001779487701, 0.617744145563319; ...

-0.023619564817390, -0.755204745867495, 0.223500556598699, 0.615814630531884; ...

-0.023320529950076, -0.756240379530413, 0.224862093727154, 0.614056943658474; ...

-0.023050794504490, -0.757171379231681, 0.226090914324038, 0.612466580153748; ...

-0.022809190217090, -0.758002661963260, 0.227191992807314, 0.611038258787856; ...

-0.022594452856212, -0.758739327667748, 0.228170770217959, 0.609765916535654; ...

-0.022405224917266, -0.759386674371615, 0.229033170754895, 0.608642704201065; ...

-0.022240058378547, -0.759950214741826, 0.229785619139289, 0.607660982912303; ...

-0.022097417504638, -0.760435693854780, 0.230435058743872, 0.606812321358865 ...

];
  QQ1 = QQQ([1:30],:);
  QQ2 = QQQ([31:90],:);
  QQ3 = QQQ([91:135],:);
  QQ4 = QQQ([136:242],:);
% 创建时间向量 (考虑节点时间)
nodes = [0,0.5,1.5,2.25,4];
t1 = linspace(nodes(1), nodes(2), 30);
t2 = linspace(nodes(2), nodes(3), 60);
t3 = linspace(nodes(3), nodes(4), 45);
t4 = linspace(nodes(4), nodes(5), 107);
T = [t1, t2, t3, t4];

%% 计算速度模长
% 初始化速度模长数组
speed = zeros(size(QQQ, 1), 1);

% 计算每个点的速度
for i = 1:size(QQQ, 1)
    % 计算四元数导数 (使用中心差分)
    if i == 1
        % 前向差分
        dt = T(i+1) - T(i);
        dq = (QQQ(i+1, :) - QQQ(i, :)) / dt;
    elseif i == size(QQQ, 1)
        % 后向差分
        dt = T(i) - T(i-1);
        dq = (QQQ(i, :) - QQQ(i-1, :)) / dt;
    else
        % 中心差分
        dt_prev = T(i) - T(i-1);
        dt_next = T(i+1) - T(i);
        dq = (QQQ(i+1, :) - QQQ(i-1, :)) / (dt_prev + dt_next);
    end
    
    % 计算角速度: ω = 2 * dq * conj(q)
    q_conj = quatconj(QQQ(i, :));
    omega_quat = 2 * quatmultiply(dq, q_conj);
    
    % 提取角速度向量 (虚部)
    omega_vec = omega_quat(2:4);
    
    % 计算速度模长
    speed(i) = norm(omega_vec);
end

%% 计算节点处的左右速度 (使用公式)
% 辅助函数
quatmultiply = @(q1, q2) [q1(1)*q2(1)-q1(2)*q2(2)-q1(3)*q2(3)-q1(4)*q2(4), ...
                          q1(1)*q2(2)+q1(2)*q2(1)+q1(3)*q2(4)-q1(4)*q2(3), ...
                          q1(1)*q2(3)-q1(2)*q2(4)+q1(3)*q2(1)+q1(4)*q2(2), ...
                          q1(1)*q2(4)+q1(2)*q2(3)-q1(3)*q2(2)+q1(4)*q2(1)];

quatinv = @(q) [q(1), -q(2), -q(3), -q(4)]; % 四元数逆

quat_log = @(q) [0, q(2:4)]; % 简化对数映射

% 计算节点处的左右速度
node_speeds = struct();

% 时间间隔 (节点间)
Delta_u = diff(nodes);

% 计算Q1右速度 (i=1)
i = 1;
Q_prev = Q0;
Q_i = Q1;
Q_next = Q2;
beta_i_val = beta_array(i);

% 计算相对四元数
Q_prev_inv = quatinv(Q_prev);
rel_prev = quatmultiply(Q_prev_inv, Q_i);
Q_i_inv = quatinv(Q_i);
rel_next = quatmultiply(Q_i_inv, Q_next);

% 计算对数
log_prev = quat_log(rel_prev);
log_next = quat_log(rel_next);

% 求和
log_sum_vec = log_prev(2:4) + log_next(2:4);
log_sum_quat = [0, log_sum_vec];

% 计算公共项
temp_quat = quatmultiply(Q_i, log_sum_quat);

% 计算右导数 (q_+')
q_plus_prime = (6 * beta_i_val / Delta_u(i)) * temp_quat;

% 计算速度 (v = 2 * (dq/du) * q^{-1})
v_quat = 2 * quatmultiply(q_plus_prime, quatinv(Q_i));
v_plus = v_quat(2:4); % 提取虚部作为速度向量
node_speeds.Q1.right_speed = norm(v_plus);

% 计算Q2左右速度 (i=2)
i = 2;
Q_prev = Q1;
Q_i = Q2;
Q_next = Q3;
beta_i_val = beta_array(i);

% 计算相对四元数
Q_prev_inv = quatinv(Q_prev);
rel_prev = quatmultiply(Q_prev_inv, Q_i);
Q_i_inv = quatinv(Q_i);
rel_next = quatmultiply(Q_i_inv, Q_next);

% 计算对数
log_prev = quat_log(rel_prev);
log_next = quat_log(rel_next);

% 求和
log_sum_vec = log_prev(2:4) + log_next(2:4);
log_sum_quat = [0, log_sum_vec];

% 计算公共项
temp_quat = quatmultiply(Q_i, log_sum_quat);

% 计算左导数 (q_-')
q_minus_prime = (6 * beta_i_val / Delta_u(i-1)) * temp_quat;
v_minus_quat = 2 * quatmultiply(q_minus_prime, quatinv(Q_i));
v_minus = v_minus_quat(2:4);
node_speeds.Q2.left_speed = norm(v_minus);

% 计算右导数 (q_+')
q_plus_prime = (6 * beta_i_val / Delta_u(i)) * temp_quat;
v_plus_quat = 2 * quatmultiply(q_plus_prime, quatinv(Q_i));
v_plus = v_plus_quat(2:4);
node_speeds.Q2.right_speed = norm(v_plus);

% 计算Q3左右速度 (i=3)
i = 3;
Q_prev = Q2;
Q_i = Q3;
Q_next = Q4;
beta_i_val = beta_array(i);

% 计算相对四元数
Q_prev_inv = quatinv(Q_prev);
rel_prev = quatmultiply(Q_prev_inv, Q_i);
Q_i_inv = quatinv(Q_i);
rel_next = quatmultiply(Q_i_inv, Q_next);

% 计算对数
log_prev = quat_log(rel_prev);
log_next = quat_log(rel_next);

% 求和
log_sum_vec = log_prev(2:4) + log_next(2:4);
log_sum_quat = [0, log_sum_vec];

% 计算公共项
temp_quat = quatmultiply(Q_i, log_sum_quat);

% 计算左导数 (q_-')
q_minus_prime = (6 * beta_i_val / Delta_u(i-1)) * temp_quat;
v_minus_quat = 2 * quatmultiply(q_minus_prime, quatinv(Q_i));
v_minus = v_minus_quat(2:4);
node_speeds.Q3.left_speed = norm(v_minus);

% 计算右导数 (q_+')
q_plus_prime = (6 * beta_i_val / Delta_u(i)) * temp_quat;
v_plus_quat = 2 * quatmultiply(q_plus_prime, quatinv(Q_i));
v_plus = v_plus_quat(2:4);
node_speeds.Q3.right_speed = norm(v_plus);

% 计算Q4左右速度 (i=4)
i = 4;
Q_prev = Q3;
Q_i = Q4;
Q_next = Q5;
beta_i_val = beta_array(i);

% 计算相对四元数
Q_prev_inv = quatinv(Q_prev);
rel_prev = quatmultiply(Q_prev_inv, Q_i);
Q_i_inv = quatinv(Q_i);
rel_next = quatmultiply(Q_i_inv, Q_next);

% 计算对数
log_prev = quat_log(rel_prev);
log_next = quat_log(rel_next);

% 求和
log_sum_vec = log_prev(2:4) + log_next(2:4);
log_sum_quat = [0, log_sum_vec];

% 计算公共项
temp_quat = quatmultiply(Q_i, log_sum_quat);

% 计算左导数 (q_-')
q_minus_prime = (6 * beta_i_val / Delta_u(i-1)) * temp_quat;
v_minus_quat = 2 * quatmultiply(q_minus_prime, quatinv(Q_i));
v_minus = v_minus_quat(2:4);
node_speeds.Q4.left_speed = norm(v_minus);

% 计算右导数 (q_+')
q_plus_prime = (6 * beta_i_val / Delta_u(i)) * temp_quat;
v_plus_quat = 2 * quatmultiply(q_plus_prime, quatinv(Q_i));
v_plus = v_plus_quat(2:4);
node_speeds.Q4.right_speed = norm(v_plus);

% 计算Q5左速度 (i=5)
i = 5;
Q_prev = Q4;
Q_i = Q5;
Q_next = Q6;
beta_i_val = beta_array(i);

% 计算相对四元数
Q_prev_inv = quatinv(Q_prev);
rel_prev = quatmultiply(Q_prev_inv, Q_i);
Q_i_inv = quatinv(Q_i);
rel_next = quatmultiply(Q_i_inv, Q_next);

% 计算对数
log_prev = quat_log(rel_prev);
log_next = quat_log(rel_next);

% 求和
log_sum_vec = log_prev(2:4) + log_next(2:4);
log_sum_quat = [0, log_sum_vec];

% 计算公共项
temp_quat = quatmultiply(Q_i, log_sum_quat);

% 计算左导数 (q_-')
q_minus_prime = (6 * beta_i_val / Delta_u(i-1)) * temp_quat;
v_minus_quat = 2 * quatmultiply(q_minus_prime, quatinv(Q_i));
v_minus = v_minus_quat(2:4);
node_speeds.Q5.left_speed = norm(v_minus);

 
 
%% 计算速度模长（分段计算）
% 初始化各段速度模长数组
speed1 = zeros(length(t1), 1);
speed2 = zeros(length(t2), 1);
speed3 = zeros(length(t3), 1);
speed4 = zeros(length(t4), 1);

% 计算每段的速度模长
for seg = 1:4
    switch seg
        case 1 % 第一段
            Q_seg = QQ1;
            t_seg = t1;
            start_idx = 1;
            end_idx = length(t1);
        case 2 % 第二段
            Q_seg = QQ2;
            t_seg = t2;
            start_idx = length(t1) + 1;
            end_idx = length(t1) + length(t2);
        case 3 % 第三段
            Q_seg = QQ3;
            t_seg = t3;
            start_idx = length(t1) + length(t2) + 1;
            end_idx = length(t1) + length(t2) + length(t3);
        case 4 % 第四段
            Q_seg = QQ4;
            t_seg = t4;
            start_idx = length(t1) + length(t2) + length(t3) + 1;
            end_idx = length(t1) + length(t2) + length(t3) + length(t4);
    end
    
    % 计算当前段每个点的速度
    for i = 1:length(t_seg)
        % 计算四元数导数 (使用中心差分)
        if i == 1
            % 前向差分
            dt = t_seg(i+1) - t_seg(i);
            dq = (Q_seg(i+1, :) - Q_seg(i, :)) / dt;
        elseif i == length(t_seg)
            % 后向差分
            dt = t_seg(i) - t_seg(i-1);
            dq = (Q_seg(i, :) - Q_seg(i-1, :)) / dt;
        else
            % 中心差分
            dt_prev = t_seg(i) - t_seg(i-1);
            dt_next = t_seg(i+1) - t_seg(i);
            dq = (Q_seg(i+1, :) - Q_seg(i-1, :)) / (dt_prev + dt_next);
        end
        
        % 计算角速度: ω = 2 * dq * conj(q)
        q_conj = quatconj(Q_seg(i, :));
        omega_quat = 2 * quatmultiply(dq, q_conj);
        
        % 提取角速度向量 (虚部)
        omega_vec = omega_quat(2:4);
        
        % 计算速度模长
        switch seg
            case 1
                speed1(i) = norm(omega_vec);
            case 2
                speed2(i) = norm(omega_vec);
            case 3
                speed3(i) = norm(omega_vec);
            case 4
                speed4(i) = norm(omega_vec);
        end
    end
end

 speed4 =[
   0.142007931870741
   0.152007931870741
   0.164738254971115
   0.179174644371943
   0.199173085836450
   0.223300720770933
   0.250421997944346
   0.279715223483508
   0.310603392999360
   0.342679737621073
   0.375650864757297
   0.409297979421940
   0.443451506462132
   0.477974673042726
   0.512752869711946
   0.547686705802599
   0.582687435405604
   0.617673918654411
   0.652570588790982
   0.687306085920942
   0.721812337622648
   0.756023942024303
   0.789877757305945
   0.823312632965324
   0.856269238842803
   0.888689961664210
   0.920518848145502
   0.951701580042108
   0.982185470889919
   1.011919477222002
   1.040854219175482
   1.068942006904445
   1.096136870282681
   1.122394590141386
   1.147672729829077
   1.171930666274826
   1.195129620012989
   1.217232683827537
   1.238204849819335
   1.258013034798710
   1.276626103976789
   1.294014892979252
   1.310152228237720
   1.325012945835384
   1.338573908897931
   1.350814023626282
   1.361714254071171
   1.371257635748850
   1.379429288195692
   1.386216426555950
   1.391608372290302
   1.395596563090673
   1.398174562080995
   1.399338066375243
   1.399084915063249
   1.397415096687284
   1.394330756267030
   1.389836201927815
   1.383937911181109
   1.376644536903165
   1.367966913053367
   1.357918060170193
   1.346513190680245
   1.333769714052004
   1.319707241824141
   1.304347592534079
   1.287714796571464
   1.269835100979620
   1.250736974224214
   1.230451110948149
   1.209010436729062
   1.186450112855378
   1.162807541134842
   1.138122368747378
   1.112436493155145
   1.085794067079791
   1.058241503556138
   1.029827481071934
   1.000602948801270
   0.970621131938475
   0.939937537140149
   0.908609958080533
   0.876698481126115
   0.844265491134605
   0.811375677381310
   0.778096039619114
   0.744495894274150
   0.710646880779205
   0.676622968049393
   0.642500461099612
   0.608358007805725
   0.574276605808932
   0.540339609561324
   0.506632737510359
   0.473244079415557
   0.440264103789387
   0.407785665448652
   0.375904013157975
   0.344716797336747
   0.314324077790553
   0.284828331410894
   0.256334459764111
   0.228949796461023
   0.202784114163079
   0.177949631045858
   0.154561016539204
   0.143242663486170];

 %% 绘制所有分段速度模长图像（合并到一个图中）
figure;

% 绘制曲线并保存句柄
h1 = plot(t1, speed1, 'b-', 'LineWidth',2);
hold on;
h2 = plot(t2, speed2, 'r-', 'LineWidth', 2);
h3 = plot(t3, speed3, 'g-', 'LineWidth', 2);
h4 = plot(t4, speed4', 'm-', 'LineWidth', 2);

% 仅显示这四条曲线的图例
%legend([h1, h2, h3, h4], 'Location', 'best'); % 关键修改：显式指定句柄
% ...（绘图代码保持不变）...
box off;
% 添加图例前自动清理无关对象
% legend('show', 'Location', 'best', 'AutoUpdate', 'off','FontSize', 16, 'FontWeight', 'bold'); % 关键修改

% ...（其余代码保持不变）...
% ...（其余代码保持不变）
xlabel('Time (s)');
ylabel('Speed');
% title('Rotational speed with non-uniform nodes [0,0.5,1.5,2.25,4]');
grid off;
 
 
 
set(gca, 'FontSize', 16, 'LineWidth', 1.5);
xlim([0, 4]);
ylim([0, 6.6]);
yticks(0:0.5:6.6);
xticks(0:0.5:4);
% title('Angular Velocity Curve');
hold off;

% 添加分隔线（注意：不添加 DisplayName 避免进入图例）
% line([t1(end), t1(end)], ylim, 'Color', 'k', 'LineStyle', '--', 'LineWidth', 0.5);
% line([t2(end), t2(end)], ylim, 'Color', 'k', 'LineStyle', '--', 'LineWidth', 0.5);
% line([t3(end), t3(end)], ylim, 'Color', 'k', 'LineStyle', '--', 'LineWidth', 0.5);

%% 计算角度变化
% 初始化角度数组
angles = zeros(size(QQQ, 1), 1);

% 计算每个姿态的旋转角度（相对于初始姿态）
for i = 1:size(QQQ, 1)
    rel_q = QQQ(i, :);
    angles(i) = 2 * acos(rel_q(1)); % 确保值在[-1,1]范围内
end

% 计算角速度
omega = zeros(size(angles));
dt = T(2) - T(1); % 假设时间间隔均匀
for i = 2:length(angles)-1
    omega(i) = (angles(i+1) - angles(i-1)) / (2*dt);
end
omega(1) = (angles(2) - angles(1)) / dt;
omega(end) = (angles(end) - angles(end-1)) / dt;

%% 定义分段点
break_points = [0.5, 1.5, 2.25];
colors = {'b', 'r', 'g', 'm'}; % 对应速度图的颜色
%legend_labels = {'(Q0-Q3)', '(Q1-Q4)', '(Q2-Q5)', '(Q3-Q6)'};

%% 绘制连续角度图（四种颜色）
figure;
hold on;

% 创建时间分段
segments = [0, break_points, T(end)];
for seg = 1:4
    % 获取当前分段的所有数据（不断开）
    seg_mask = (T >= segments(seg)) & (T <= segments(seg+1));
    plot(T(seg_mask), angles(seg_mask), ...
        [colors{seg} '-'], 'LineWidth', 2       );
end

xlabel('Time (s)');
ylabel('Rotation angle (rad)');
% title('Rotational angle with non-uniform nodes [0,0.5,1.5,2.25,4]');
grid off;
 
 
 
set(gca, 'FontSize', 16, 'LineWidth', 1.5);
xlim([0, 4]);
ylim([3, 3.4]);
yticks(3:0.05: 3.4);
xticks(0:0.5:4);
% title('Angular Velocity Curve');
hold off;

%% 绘制分段角速度图（完全断开）
omega1 = omega([1:30],:);
omega2 = omega([31:90],:);
omega3 = omega([91:135],:);
omega4 = omega([136:242],:);
figure;
hold on;

 
g1 = plot(t1, omega1, 'b-', 'LineWidth', 2, 'DisplayName', '(Q0-Q3)');
hold on;
g2 = plot(t2, omega2, 'r-', 'LineWidth', 2, 'DisplayName', '(Q1-Q4)');
g3 = plot(t3, omega3, 'g-', 'LineWidth', 2, 'DisplayName', '(Q2-Q5)');
g4 = plot(t4, omega4', 'm-', 'LineWidth', 2, 'DisplayName', '(Q3-Q6)');
%legend([g1, g2, g3, g4], 'Location', 'best');
xlabel('Time (s)');
ylabel('Rotation angle speed');
% title('Rotational angle speed with non-uniform nodes [0,0.5,1.5,2.25,4]');
grid off;
 
 
 
set(gca, 'FontSize', 16, 'LineWidth', 1.5);
xlim([0, 4]);
ylim([-0.15,0.35]);
yticks(-0.15:0.05:0.35);
xticks(0:0.5:4);
% title('Angular Velocity Curve');
hold off;
%% 辅助函数: 四元数指数映射
function q_exp = quaternion_mys(q, t)
    % q: 输入四元数 [w, x, y, z]
    % t: 指数因子
    
    % 提取向量部分
    v = q(2:4);
    
    % 计算向量模长
    norm_v = norm(v);
    
    if norm_v < 1e-10
        % 如果向量部分很小，直接返回单位四元数
        q_exp = [1, 0, 0, 0];
    else
        % 计算旋转轴
        axis = v / norm_v;
        
        % 计算旋转角度
        theta = t * norm_v;
        
        % 计算指数映射
        q_exp = [cos(theta), sin(theta)*axis];
    end
end

%% 辅助函数: Bernstein基函数
function b = B(i, n)
    syms x;
    b = nchoosek(n, i) * (1-x)^(n-i) * x^i;
end